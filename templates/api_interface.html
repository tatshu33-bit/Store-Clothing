{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    <h1 class="mb-4">API Frontend Interface</h1>
    <p class="text-muted">This interface demonstrates interaction with the backend API using JavaScript</p>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="resourceTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" 
                    type="button" role="tab">Products</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback" 
                    type="button" role="tab">Feedback</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="resourceTabsContent">
        <!-- Products Tab -->
        <div class="tab-pane fade show active" id="products" role="tabpanel">
            <div class="row">
                <!-- Add Product Form -->
                <div class="col-md-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Add New Product</h5>
                        </div>
                        <div class="card-body">
                            <form id="addProductForm">
                                <div class="mb-3">
                                    <label for="productTitle" class="form-label">Title <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="productTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="productDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="productPrice" class="form-label">Price (USD) <span class="text-danger">*</span></label>
                                    <input type="number" step="0.01" class="form-control" id="productPrice" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productImage" class="form-label">Image URL</label>
                                    <input type="url" class="form-control" id="productImage" 
                                           placeholder="https://example.com/image.jpg">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <span class="spinner-border spinner-border-sm d-none" id="productSpinner"></span>
                                    Add Product
                                </button>
                            </form>
                            <div id="productMessage" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Products List -->
                <div class="col-md-7">
                    <div class="card shadow-sm">
                        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Products List</h5>
                            <button class="btn btn-sm btn-light" onclick="loadProducts()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="productsLoading" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div id="productsList" class="d-none"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback Tab -->
        <div class="tab-pane fade" id="feedback" role="tabpanel">
            <div class="row">
                <!-- Add Feedback Form -->
                <div class="col-md-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Submit Feedback</h5>
                        </div>
                        <div class="card-body">
                            <form id="addFeedbackForm">
                                <div class="mb-3">
                                    <label for="feedbackName" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="feedbackName" placeholder="Anonymous">
                                </div>
                                <div class="mb-3">
                                    <label for="feedbackEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="feedbackEmail">
                                </div>
                                <div class="mb-3">
                                    <label for="feedbackMessage" class="form-label">Message <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="feedbackMessage" rows="4" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-success w-100">
                                    <span class="spinner-border spinner-border-sm d-none" id="feedbackSpinner"></span>
                                    Submit Feedback
                                </button>
                            </form>
                            <div id="feedbackMessage" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Feedback List -->
                <div class="col-md-7">
                    <div class="card shadow-sm">
                        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Feedback List</h5>
                            <button class="btn btn-sm btn-light" onclick="loadFeedback()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="feedbackLoading" class="text-center py-4">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div id="feedbackList" class="d-none"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .api-interface-card {
        transition: transform 0.2s;
    }
    .api-interface-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .product-item {
        border-left: 4px solid #0d6efd;
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
    }
    .feedback-item {
        border-left: 4px solid #198754;
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
    }
    .resource-count {
        font-size: 0.9rem;
        color: #6c757d;
    }
</style>

<script>
// Load products from API
async function loadProducts() {
    const loadingEl = document.getElementById('productsLoading');
    const listEl = document.getElementById('productsList');
    
    loadingEl.classList.remove('d-none');
    listEl.classList.add('d-none');
    
    try {
        const response = await fetch('/api/products');
        const data = await response.json();
        
        if (data.success) {
            displayProducts(data.products);
        } else {
            listEl.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
        }
    } catch (error) {
        listEl.innerHTML = `<div class="alert alert-danger">Failed to load products: ${error.message}</div>`;
    } finally {
        loadingEl.classList.add('d-none');
        listEl.classList.remove('d-none');
    }
}

function displayProducts(products) {
    const listEl = document.getElementById('productsList');
    
    if (products.length === 0) {
        listEl.innerHTML = '<p class="text-muted">No products available.</p>';
        return;
    }
    
    let html = `<p class="resource-count mb-3">Total products: <strong>${products.length}</strong></p>`;
    html += '<div class="products-container">';
    
    products.forEach(product => {
        html += `
            <div class="product-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${escapeHtml(product.title)}</h6>
                        <p class="mb-1 text-muted small">${escapeHtml(product.description || 'No description')}</p>
                        <p class="mb-0"><strong class="text-primary">$${(product.price || 0).toFixed(2)}</strong></p>
                    </div>
                    ${product.image_url ? `<img src="${escapeHtml(product.image_url)}" class="ms-3" style="width: 80px; height: 80px; object-fit: cover; border-radius: 0.25rem;" alt="${escapeHtml(product.title)}">` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    listEl.innerHTML = html;
}

// Add product
document.getElementById('addProductForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const spinner = document.getElementById('productSpinner');
    const messageEl = document.getElementById('productMessage');
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    // Get form values
    const productData = {
        title: document.getElementById('productTitle').value,
        description: document.getElementById('productDescription').value,
        price: parseFloat(document.getElementById('productPrice').value),
        image_url: document.getElementById('productImage').value
    };
    
    // Show loading
    spinner.classList.remove('d-none');
    submitBtn.disabled = true;
    messageEl.innerHTML = '';
    
    try {
        const response = await fetch('/api/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(productData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            messageEl.innerHTML = `<div class="alert alert-success alert-dismissible fade show">
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            e.target.reset();
            loadProducts(); // Refresh the list
        } else {
            messageEl.innerHTML = `<div class="alert alert-danger alert-dismissible fade show">
                Error: ${data.error}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }
    } catch (error) {
        messageEl.innerHTML = `<div class="alert alert-danger alert-dismissible fade show">
            Failed to add product: ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    } finally {
        spinner.classList.add('d-none');
        submitBtn.disabled = false;
    }
});

// Load feedback from API
async function loadFeedback() {
    const loadingEl = document.getElementById('feedbackLoading');
    const listEl = document.getElementById('feedbackList');
    
    loadingEl.classList.remove('d-none');
    listEl.classList.add('d-none');
    
    try {
        const response = await fetch('/api/feedback');
        const data = await response.json();
        
        if (data.success) {
            displayFeedback(data.feedback);
        } else {
            listEl.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
        }
    } catch (error) {
        listEl.innerHTML = `<div class="alert alert-danger">Failed to load feedback: ${error.message}</div>`;
    } finally {
        loadingEl.classList.add('d-none');
        listEl.classList.remove('d-none');
    }
}

function displayFeedback(feedbacks) {
    const listEl = document.getElementById('feedbackList');
    
    if (feedbacks.length === 0) {
        listEl.innerHTML = '<p class="text-muted">No feedback available.</p>';
        return;
    }
    
    let html = `<p class="resource-count mb-3">Total feedback: <strong>${feedbacks.length}</strong></p>`;
    html += '<div class="feedback-container" style="max-height: 600px; overflow-y: auto;">';
    
    feedbacks.forEach(fb => {
        html += `
            <div class="feedback-item">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">${escapeHtml(fb.name)}</h6>
                    <small class="text-muted">${fb.created_at}</small>
                </div>
                ${fb.email ? `<p class="mb-1 small text-muted">${escapeHtml(fb.email)}</p>` : ''}
                <p class="mb-0">${escapeHtml(fb.message)}</p>
            </div>
        `;
    });
    
    html += '</div>';
    listEl.innerHTML = html;
}

// Add feedback
document.getElementById('addFeedbackForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const spinner = document.getElementById('feedbackSpinner');
    const messageEl = document.getElementById('feedbackMessage');
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    // Get form values
    const feedbackData = {
        name: document.getElementById('feedbackName').value || 'Anonymous',
        email: document.getElementById('feedbackEmail').value,
        message: document.getElementById('feedbackMessage').value
    };
    
    // Show loading
    spinner.classList.remove('d-none');
    submitBtn.disabled = true;
    messageEl.innerHTML = '';
    
    try {
        const response = await fetch('/api/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(feedbackData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            messageEl.innerHTML = `<div class="alert alert-success alert-dismissible fade show">
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            e.target.reset();
            loadFeedback(); // Refresh the list
        } else {
            messageEl.innerHTML = `<div class="alert alert-danger alert-dismissible fade show">
                Error: ${data.error}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }
    } catch (error) {
        messageEl.innerHTML = `<div class="alert alert-danger alert-dismissible fade show">
            Failed to submit feedback: ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    } finally {
        spinner.classList.add('d-none');
        submitBtn.disabled = false;
    }
});

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load products on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    
    // Load feedback when tab is shown
    document.getElementById('feedback-tab').addEventListener('shown.bs.tab', () => {
        loadFeedback();
    });
});
</script>
{% endblock %}
